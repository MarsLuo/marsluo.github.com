---
layout: post  
title:  "从 Git Hook 说开去"  
date:   2021-09-12 11:16:48
comments: ture
categories: Notes  
tags: [git]  
---

一、缘起

最近我在一个咨询项目上，客户有一个诉求，要求开发人员在编辑提交信息时，符合对应的格式。若不符合格式的，则不能提交。  
经与客户研讨后，初步商定使用 Git Hooks 完成对应的技术诉求。（客户目前使用的是自有部署的GitLab，且暂无定制化开发能力）

经过分析，此需求初步分为两个子任务：
1. 如何通过 Git Hooks 检查开发人员给与的提交信息不符合要求，在不符合要求时，不予许提交。
2. 如何在开发人员无法提交时，给开发人员提示正确的格式。

经过查阅GitHooks的[文档](https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks)，可以发现只要修改每一个仓库内, `.git\hooks`下的脚本文件即可完成上述功能。

```
#!/bin/sh

commitMsgFilePath=$1
commitMsgContent=$(cat "$commitMsgFile")
regString='^\[[0-9]{5,10}\](build|ci|docs|feat|fix|perf|refactor|style|test):.*$'

# 检验是否符合格式
if [[ $commitMsgContent =~ $regString ]]
then
    exit 0
fi

exit 1
```

接着，只需要在提交信息不符合格式的时候，使用`echo`给开发人员对应的提示就好了。So easy！

紧接着，我们又发现一个问题， 这样配置在个人机器上是没问题的，但是如果每个仓库每个开发人员都要配置一次，这个工作量就太大了，而且还要考虑到脚本变化的情况， 这个成本无论是我们还是客户都是很难接受的。

所以，第三个Task 出现了： 如何将Git 脚本版本化。

经过简单的调研发现，无论是Java相关的技术栈，还是JS相关的技术栈，都有比较成熟的方案。

Java 相关的技术栈，比如 Spring 项目，Android项目等，可以使用Gradle的相关配置功能，将配置脚本纳入版本管理中，在`gradle build`时，再拷贝到 `.git\hooks`  目录中。 具体实现步骤，大家可以参见腾云的这个[项目]( https://github.com/e-commerce-sample/ecommerce-order-service)。

Js 相关的技术栈，可以使用 `husky` 来完成对应的配置。他依赖Npm的安装和配置，具体的使用方式可以参见他的[项目主页](https://github.com/typicode/husky)。

二、普遍解法

以上两种方式，都需要依靠特定的依赖管理工具才能完成。那依赖管理工具不支持，或者没有依赖管理工具，还想完成版本化管理  Git hooks 怎么办呢？ 

Git hooks 的脚本文件都存放在`.git\hooks`目录下，但是该目录并不能被纳入版本管理中。经过查阅 `husky` 和 `git` 的文档可知， 在17年 Git 提供了一项配置： `core.hooksPath`，通过它，可以将指定某个目录存放 git hook 的相关脚本。同时，该目录也可以纳入版本管理。

执行命令如下：

`git config --add core.hookspath .mygithooks`

三、Git Hooks 还能做什么？

Git Hooks 还能做什么？ 想要回答这个问题，可能要先了解一下Git Hooks的定义了。  

```
Git Hooks 是 一系列脚本， Git 允许 Git 仓库在触发某些事件时，去执行这些脚本。 我们可以通过 Git Hooks 在代码提交的关键节点，触发自定义的操作。
```

由此可见，Git Hooks 的灵活性还是很强的。

Git Hooks 分两种，客户端Hooks 和服务端Hooks。 客户端 Hooks 会被 commit，merge，rebase 等操作触发，而服务端会被push等操作触发。

下图是 Git Hooks 的生命周期：



介绍生命周期

介绍每个Hooks的 触发机制，传递参数等。

介绍每个阶段可以做哪些事情。

介绍服务端强制回退的例子。

https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks

https://git-scm.com/book/en/v2/Customizing-Git-An-Example-Git-Enforced-Policy#_an_example_git_enforced_policy

## 一、初识 Git Hook
## 二、git hook 的分类
## 三、git hook 的使用场景
## 四、Git hook 的版本化
## 五、其他问题

